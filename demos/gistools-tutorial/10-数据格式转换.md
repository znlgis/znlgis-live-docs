# 数据格式转换

## 概述

数据格式转换是GIS数据处理中最常见的需求之一。本章对前面各章介绍的格式转换方法进行总结，并提供一个统一的转换框架。

## 转换框架

### 中间数据模型

所有格式转换都通过WktLayer作为中间模型：

```
源格式 → WktLayer → 目标格式
```

这种设计的优点：
- 简化转换逻辑，避免N×N的格式组合
- 便于在转换过程中进行数据处理
- 统一的数据模型，便于扩展新格式

### WktLayer结构

```java
WktLayer
├── ywName/zwName     // 图层名称
├── wkid              // 坐标系代码
├── geometryType      // 几何类型
├── tolerance         // 容差
├── fields            // 字段定义
│   └── WktField
│       ├── ywName/zwName  // 字段名
│       └── dataType       // 数据类型
└── features          // 要素列表
    └── WktFeature
        ├── wfId      // 要素ID
        ├── wkt       // 几何WKT
        └── fieldValues  // 属性值列表
```

## 支持的格式

### 数据格式枚举

```java
public enum DataFormatType {
    WKT("WKT", null),
    GEOJSON("GEOJSON", "GeoJSON"),
    ESRIJSON("ESRIJSON", "ESRIJSON"),
    SHP("SHP文件", "ESRI Shapefile"),
    TXT("国土TXT", null),
    FILEGDB("FILEGDB", "OpenFileGDB"),
    POSTGIS("POSTGIS", "PostgreSQL"),
    ARCSDE("ARCSDE", null);
    
    private final String desc;
    private final String gdalDriverName;
}
```

### 格式对比

| 格式 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| Shapefile | 兼容性好，行业标准 | 字段名10字符限制，多文件 | 数据交换 |
| GeoJSON | 可读性好，Web友好 | 文件体积大 | Web展示 |
| FileGDB | 功能丰富，性能好 | 需要GDAL支持 | ArcGIS生态 |
| PostGIS | 查询强大，支持并发 | 需要数据库 | 企业应用 |
| 国土TXT | 国土部门标准 | 仅支持面数据 | 土地业务 |
| WKT | 通用文本格式 | 无属性支持 | 临时交换 |

## 转换方法汇总

### 从各格式到WktLayer

```java
// Shapefile → WktLayer
WktLayer layer = WktLayerConverter.fromShapefile(
    shpPath, attributeFilter, spatialFilter, GisEngineType.GEOTOOLS);

// GeoJSON → WktLayer
WktLayer layer = WktLayerConverter.fromGeoJSON(
    geojsonPath, GisEngineType.GEOTOOLS);

// FileGDB → WktLayer
WktLayer layer = WktLayerConverter.fromFileGDB(
    gdbPath, layerName, attributeFilter, spatialFilter, GisEngineType.GDAL);

// PostGIS → WktLayer
WktLayer layer = WktLayerConverter.fromPostGIS(
    dbConnModel, layerName, attributeFilter, spatialFilter, GisEngineType.GEOTOOLS);

// 国土TXT → WktLayer
TxtLayer txtLayer = TxtLayerUtil.loadTxt(txtPath);
WktLayer layer = TxtLayerUtil.parseTxtLayerToWktLayer(txtLayer, fields);

// SimpleFeatureCollection → WktLayer
WktLayer layer = WktLayerConverter.fromSimpleFeatureCollection(featureCollection);
```

### 从WktLayer到各格式

```java
// WktLayer → Shapefile
WktLayerConverter.toShapefile(layer, shpPath, GisEngineType.GEOTOOLS);

// WktLayer → GeoJSON
WktLayerConverter.toGeoJSON(layer, geojsonPath, GisEngineType.GEOTOOLS);

// WktLayer → FileGDB
WktLayerConverter.toFileGDB(layer, gdbPath, featureDataset, layerName, GisEngineType.GDAL);

// WktLayer → PostGIS
WktLayerConverter.toPostGIS(layer, dbConnModel, layerName, GisEngineType.GEOTOOLS);

// WktLayer → 国土TXT
TxtLayer txtLayer = TxtLayerUtil.parseWktLayerToTxtLayer(layer, template, fields, dh);
TxtLayerUtil.saveTxt(txtLayer, txtPath);

// WktLayer → SimpleFeatureCollection
SimpleFeatureCollection fc = WktLayerConverter.toSimpleFeatureCollection(layer);
```

## 几何格式转换

### WKT与其他格式

```java
// WKT → JTS Geometry
Geometry geom = GeometryConverter.wkt2Geometry(wkt);

// JTS Geometry → WKT
String wkt = GeometryConverter.geometry2Wkt(geom);

// WKT → GeoJSON
String geojson = GeometryConverter.wkt2Geojson(wkt);

// GeoJSON → WKT
String wkt = GeometryConverter.geojson2Wkt(geojson);

// WKT → EsriJSON
String esriJson = GeometryConverter.wkt2EsriJson(wkt, wkid);

// EsriJSON → WKT
String wkt = GeometryConverter.esriJson2Wkt(esriJson);
```

### GeoJSON与EsriJSON

```java
// GeoJSON → EsriJSON
String esriJson = GeometryConverter.geoJson2EsriJson(wkid, geojson);

// EsriJSON → GeoJSON
String geojson = GeometryConverter.esriJson2GeoJson(esriJson);
```

## 通用转换工具类

### 格式自动识别

```java
/**
 * 根据文件后缀自动识别格式并读取
 */
public static WktLayer loadFromFile(String filePath) {
    String ext = FileUtil.extName(filePath).toLowerCase();
    
    switch (ext) {
        case "shp":
            return WktLayerConverter.fromShapefile(
                filePath, null, null, GisEngineType.GEOTOOLS);
        case "geojson":
        case "json":
            return WktLayerConverter.fromGeoJSON(
                filePath, GisEngineType.GEOTOOLS);
        case "txt":
            TxtLayer txtLayer = TxtLayerUtil.loadTxt(filePath);
            return TxtLayerUtil.parseTxtLayerToWktLayer(txtLayer, null);
        case "gdb":
            // GDB需要指定图层名
            throw new RuntimeException("GDB格式需要指定图层名");
        default:
            throw new RuntimeException("不支持的格式: " + ext);
    }
}

/**
 * 根据文件后缀自动识别格式并保存
 */
public static void saveToFile(WktLayer layer, String filePath) {
    String ext = FileUtil.extName(filePath).toLowerCase();
    
    switch (ext) {
        case "shp":
            WktLayerConverter.toShapefile(layer, filePath, GisEngineType.GEOTOOLS);
            break;
        case "geojson":
        case "json":
            WktLayerConverter.toGeoJSON(layer, filePath, GisEngineType.GEOTOOLS);
            break;
        case "txt":
            TxtLayer txtLayer = TxtLayerUtil.parseWktLayerToTxtLayer(
                layer, null, null, null);
            TxtLayerUtil.saveTxt(txtLayer, filePath);
            break;
        default:
            throw new RuntimeException("不支持的格式: " + ext);
    }
}
```

### 批量转换工具

```java
/**
 * 批量格式转换
 */
public static void batchConvert(String inputDir, String outputDir, 
        String sourceExt, String targetExt) {
    File dir = new File(inputDir);
    File[] files = dir.listFiles((d, name) -> 
        name.toLowerCase().endsWith("." + sourceExt));
    
    if (files == null) return;
    
    for (File file : files) {
        try {
            // 读取
            WktLayer layer = loadFromFile(file.getAbsolutePath());
            
            // 生成输出路径
            String outputName = FileUtil.mainName(file) + "." + targetExt;
            String outputPath = outputDir + File.separator + outputName;
            
            // 保存
            saveToFile(layer, outputPath);
            
            System.out.println("转换成功: " + file.getName() + " → " + outputName);
        } catch (Exception e) {
            System.err.println("转换失败: " + file.getName() + " - " + e.getMessage());
        }
    }
}
```

## 转换过程中的处理

### 坐标系转换

```java
/**
 * 转换时指定目标坐标系
 */
public static WktLayer convertWithReproject(String inputPath, String outputPath,
        Integer targetWkid) {
    // 读取
    WktLayer layer = loadFromFile(inputPath);
    
    // 坐标转换
    if (layer.getWkid() != targetWkid) {
        layer = CrsUtil.reproject(layer, targetWkid);
    }
    
    // 保存
    saveToFile(layer, outputPath);
    
    return layer;
}
```

### 字段映射

```java
/**
 * 转换时进行字段映射
 */
public static WktLayer convertWithFieldMapping(String inputPath, String outputPath,
        Map<String, String> fieldMapping) {
    // 读取
    WktLayer layer = loadFromFile(inputPath);
    
    // 字段重命名
    for (WktField field : layer.getFields()) {
        if (fieldMapping.containsKey(field.getYwName())) {
            field.setYwName(fieldMapping.get(field.getYwName()));
        }
    }
    
    // 更新要素中的字段引用
    for (WktFeature feature : layer.getFeatures()) {
        for (WktFieldValue fv : feature.getFieldValues()) {
            if (fieldMapping.containsKey(fv.getField().getYwName())) {
                fv.getField().setYwName(fieldMapping.get(fv.getField().getYwName()));
            }
        }
    }
    
    // 保存
    saveToFile(layer, outputPath);
    
    return layer;
}
```

### 数据过滤

```java
/**
 * 转换时进行数据过滤
 */
public static WktLayer convertWithFilter(String inputPath, String outputPath,
        WktFeatureFilter filter) {
    // 读取
    WktLayer layer = loadFromFile(inputPath);
    
    // 过滤
    List<WktFeature> filtered = layer.applyFilter(filter);
    layer.setFeatures(filtered);
    
    // 保存
    saveToFile(layer, outputPath);
    
    return layer;
}

// 使用示例
WktLayer result = convertWithFilter("input.shp", "output.shp", 
    feature -> {
        // 过滤条件：面积大于1000
        Geometry geom = GeometryConverter.wkt2Geometry(feature.getWkt());
        return geom.getArea() > 1000;
    });
```

### 几何简化

```java
/**
 * 转换时进行几何简化
 */
public static WktLayer convertWithSimplify(String inputPath, String outputPath,
        double tolerance) {
    // 读取
    WktLayer layer = loadFromFile(inputPath);
    
    // 简化几何
    for (WktFeature feature : layer.getFeatures()) {
        Geometry geom = GeometryConverter.wkt2Geometry(feature.getWkt());
        Geometry simplified = JTSGeometryUtil.simplify(geom, tolerance);
        feature.setWkt(simplified.toText());
    }
    
    // 保存
    saveToFile(layer, outputPath);
    
    return layer;
}
```

## 实践案例

### 案例1：Web数据准备流程

```java
/**
 * 准备Web展示数据
 * Shapefile → 坐标转换 → 简化 → GeoJSON
 */
public void prepareWebData(String shpPath, String geojsonPath) {
    // 1. 读取Shapefile
    WktLayer layer = WktLayerConverter.fromShapefile(
        shpPath, null, null, GisEngineType.GEOTOOLS);
    
    // 2. 转换到WGS84（Web地图常用）
    if (layer.getWkid() != 4490 && layer.getWkid() != 4326) {
        layer = CrsUtil.reproject(layer, 4490);
    }
    
    // 3. 简化几何（减小文件体积）
    double tolerance = 0.0001;  // 约11米
    for (WktFeature feature : layer.getFeatures()) {
        Geometry geom = GeometryConverter.wkt2Geometry(feature.getWkt());
        if (geom.getNumPoints() > 100) {
            Geometry simplified = JTSGeometryUtil.simplify(geom, tolerance);
            feature.setWkt(simplified.toText());
        }
    }
    
    // 4. 输出GeoJSON
    WktLayerConverter.toGeoJSON(layer, geojsonPath, GisEngineType.GEOTOOLS);
}
```

### 案例2：数据入库流程

```java
/**
 * 数据入库流程
 * Shapefile/GeoJSON → 数据验证 → 坐标统一 → 入库
 */
public void importToDatabase(String filePath, DbConnBaseModel dbConn,
        String tableName, Integer standardWkid) {
    // 1. 读取数据
    WktLayer layer = loadFromFile(filePath);
    
    // 2. 数据验证
    List<String> errors = new ArrayList<>();
    for (WktFeature feature : layer.getFeatures()) {
        Geometry geom = GeometryConverter.wkt2Geometry(feature.getWkt());
        IsValidModel valid = JTSGeometryUtil.isValid(geom);
        if (!valid.isValid()) {
            // 尝试修复
            Geometry fixed = JTSGeometryUtil.validate(geom);
            if (fixed.isValid()) {
                feature.setWkt(fixed.toText());
            } else {
                errors.add("要素 " + feature.getWfId() + " 无法修复");
            }
        }
    }
    
    if (!errors.isEmpty()) {
        System.err.println("验证错误: " + String.join(", ", errors));
    }
    
    // 3. 坐标统一
    if (layer.getWkid() != standardWkid) {
        layer = CrsUtil.reproject(layer, standardWkid);
    }
    
    // 4. 入库
    WktLayerConverter.toPostGIS(layer, dbConn, tableName, GisEngineType.GEOTOOLS);
}
```

### 案例3：数据导出流程

```java
/**
 * 数据导出流程
 * PostGIS → 空间过滤 → 坐标转换 → 多格式输出
 */
public void exportData(DbConnBaseModel dbConn, String tableName, 
        String boundaryWkt, String outputDir) {
    // 1. 从数据库读取（带空间过滤）
    WktLayer layer = WktLayerConverter.fromPostGIS(
        dbConn, tableName, null, boundaryWkt, GisEngineType.GEOTOOLS);
    
    // 2. 输出多种格式
    String baseName = tableName + "_export";
    
    // Shapefile（保持原始坐标系）
    WktLayerConverter.toShapefile(layer, 
        outputDir + "/" + baseName + ".shp", GisEngineType.GEOTOOLS);
    
    // GeoJSON（转换到WGS84）
    WktLayer geoLayer = CrsUtil.reproject(layer, 4490);
    WktLayerConverter.toGeoJSON(geoLayer, 
        outputDir + "/" + baseName + ".geojson", GisEngineType.GEOTOOLS);
    
    // 国土TXT
    TxtLayer txtLayer = TxtLayerUtil.parseWktLayerToTxtLayer(
        layer, null, null, null);
    TxtLayerUtil.saveTxt(txtLayer, outputDir + "/" + baseName + ".txt");
}
```

### 案例4：格式转换服务

```java
/**
 * 通用格式转换服务
 */
public class FormatConvertService {
    
    /**
     * 转换配置
     */
    @Data
    public static class ConvertConfig {
        private Integer targetWkid;           // 目标坐标系
        private Double simplifyTolerance;     // 简化容差
        private Map<String, String> fieldMapping;  // 字段映射
        private List<String> keepFields;      // 保留字段
        private boolean validateGeometry;     // 是否验证几何
    }
    
    /**
     * 执行转换
     */
    public WktLayer convert(String inputPath, String outputPath, 
            ConvertConfig config) {
        // 读取
        WktLayer layer = loadFromFile(inputPath);
        
        // 坐标转换
        if (config.getTargetWkid() != null && 
            !config.getTargetWkid().equals(layer.getWkid())) {
            layer = CrsUtil.reproject(layer, config.getTargetWkid());
        }
        
        // 字段处理
        if (config.getKeepFields() != null) {
            filterFields(layer, config.getKeepFields());
        }
        if (config.getFieldMapping() != null) {
            mapFields(layer, config.getFieldMapping());
        }
        
        // 几何处理
        if (config.isValidateGeometry()) {
            validateAndFixGeometry(layer);
        }
        if (config.getSimplifyTolerance() != null) {
            simplifyGeometry(layer, config.getSimplifyTolerance());
        }
        
        // 保存
        saveToFile(layer, outputPath);
        
        return layer;
    }
    
    private void filterFields(WktLayer layer, List<String> keepFields) {
        layer.getFields().removeIf(f -> !keepFields.contains(f.getYwName()));
        for (WktFeature feature : layer.getFeatures()) {
            feature.getFieldValues().removeIf(
                v -> !keepFields.contains(v.getField().getYwName()));
        }
    }
    
    private void mapFields(WktLayer layer, Map<String, String> mapping) {
        for (WktField field : layer.getFields()) {
            if (mapping.containsKey(field.getYwName())) {
                field.setYwName(mapping.get(field.getYwName()));
            }
        }
    }
    
    private void validateAndFixGeometry(WktLayer layer) {
        for (WktFeature feature : layer.getFeatures()) {
            Geometry geom = GeometryConverter.wkt2Geometry(feature.getWkt());
            if (!geom.isValid()) {
                Geometry fixed = JTSGeometryUtil.validate(geom);
                feature.setWkt(fixed.toText());
            }
        }
    }
    
    private void simplifyGeometry(WktLayer layer, double tolerance) {
        for (WktFeature feature : layer.getFeatures()) {
            Geometry geom = GeometryConverter.wkt2Geometry(feature.getWkt());
            Geometry simplified = JTSGeometryUtil.simplify(geom, tolerance);
            feature.setWkt(simplified.toText());
        }
    }
}
```

## 小结

本章总结了数据格式转换的核心内容：

1. **统一框架**：以WktLayer为中间模型的转换架构
2. **格式支持**：Shapefile、GeoJSON、FileGDB、PostGIS、国土TXT
3. **转换方法**：各格式与WktLayer的互转方法
4. **附加处理**：坐标转换、字段映射、数据过滤、几何简化
5. **实践案例**：Web数据准备、数据入库、数据导出、转换服务

通过本教程的学习，您应该能够：
- 理解GIS数据的基本概念和结构
- 熟练使用JTS进行几何计算
- 正确处理坐标系转换
- 在不同格式间转换数据
- 与PostGIS数据库进行交互
- 处理国土部门特有的TXT格式

如需了解更多细节，请参考gistools源代码和相关API文档。
