# 第8章 性能优化与高级配置

## 8.1 性能监控与分析

### 8.1.1 性能监控的重要性

在生产环境中，性能监控是确保GeoServer稳定运行的关键。通过监控可以：
- 及时发现性能瓶颈
- 预测容量需求
- 优化资源配置
- 诊断问题根源

### 8.1.2 GeoServer监控扩展

安装和配置监控扩展：

1. 下载监控扩展包
2. 解压到`WEB-INF/lib`目录
3. 重启GeoServer
4. 在管理界面启用监控功能

**监控配置：**
```properties
# monitoring.properties
monitor.storage=memory
monitor.mode=live
monitor.maxBodySize=1024
```

**访问监控数据：**
```bash
# 获取请求统计
curl -u admin:geoserver \
  http://localhost:8080/geoserver/rest/monitor/requests.json

# 获取特定时间段的请求
curl -u admin:geoserver \
  "http://localhost:8080/geoserver/rest/monitor/requests.json?from=2024-01-01&to=2024-01-31"
```

### 8.1.3 JMX监控

GeoServer支持通过JMX（Java Management Extensions）进行监控：

**启用JMX：**
```bash
export JAVA_OPTS="$JAVA_OPTS \
  -Dcom.sun.management.jmxremote \
  -Dcom.sun.management.jmxremote.port=9999 \
  -Dcom.sun.management.jmxremote.ssl=false \
  -Dcom.sun.management.jmxremote.authenticate=false"
```

**使用JConsole连接：**
```bash
jconsole localhost:9999
```

**关键监控指标：**
| 指标 | 说明 |
|------|------|
| HeapMemoryUsage | 堆内存使用情况 |
| NonHeapMemoryUsage | 非堆内存使用情况 |
| ThreadCount | 线程数量 |
| LoadedClassCount | 加载的类数量 |

### 8.1.4 外部监控工具

**Prometheus + Grafana：**

1. 安装Prometheus JMX Exporter
2. 配置GeoServer暴露JMX指标
3. 在Prometheus中配置抓取目标
4. 使用Grafana创建监控仪表板

**示例Prometheus配置：**
```yaml
scrape_configs:
  - job_name: 'geoserver'
    static_configs:
      - targets: ['localhost:9090']
```

### 8.1.5 日志分析

分析GeoServer日志以识别性能问题：

**慢请求日志配置：**
```xml
<logger name="org.geoserver.ows" level="DEBUG"/>
```

**使用awk分析日志：**
```bash
# 统计每种请求的数量
awk '/GetMap|GetFeature|GetCapabilities/ {count[$0]++} END {for (r in count) print count[r], r}' geoserver.log | sort -rn

# 查找耗时超过5秒的请求
grep -E "took [0-9]{4,}ms" geoserver.log
```

## 8.2 瓦片缓存配置

### 8.2.1 GeoWebCache概述

GeoWebCache（GWC）是GeoServer集成的瓦片缓存解决方案，可以显著提升地图服务性能。

**瓦片缓存的优势：**
- 减少重复渲染
- 降低服务器负载
- 提高响应速度
- 支持高并发访问

### 8.2.2 缓存配置

**全局缓存设置：**

1. 进入"瓦片缓存" > "缓存默认值"
2. 配置全局参数：
   - 启用/禁用缓存
   - 默认缓存时间
   - 默认输出格式

**图层缓存设置：**

1. 进入"瓦片缓存" > "图层缓存"
2. 选择要配置的图层
3. 设置：
   - 启用缓存
   - TileMatrixSet（坐标系和级别）
   - 输出格式
   - 过期时间
   - 元瓦片大小

### 8.2.3 元瓦片（Metatiling）

元瓦片技术通过一次渲染多个瓦片来提高效率：

```xml
<metaWidthHeight>
  <int>4</int>
  <int>4</int>
</metaWidthHeight>
```

元瓦片的好处：
- 减少标注重复
- 减少数据库查询次数
- 提高缓存生成效率

### 8.2.4 瓦片种子和截断

**生成瓦片缓存（种子）：**

1. 进入"瓦片缓存" > "种子和截断"
2. 选择图层
3. 配置参数：
   - 操作类型：种子
   - 格式
   - 缩放级别范围
   - 地理范围
   - 线程数
4. 提交任务

**通过REST API种子：**
```bash
curl -u admin:geoserver -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "seedRequest": {
      "name": "workspace:layer",
      "srs": {"number": 4326},
      "zoomStart": 0,
      "zoomStop": 10,
      "format": "image/png",
      "type": "seed",
      "threadCount": 4
    }
  }' \
  http://localhost:8080/geoserver/gwc/rest/seed/workspace:layer.json
```

**截断缓存：**
```bash
curl -u admin:geoserver -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "seedRequest": {
      "name": "workspace:layer",
      "type": "truncate"
    }
  }' \
  http://localhost:8080/geoserver/gwc/rest/seed/workspace:layer.json
```

### 8.2.5 缓存存储配置

**文件系统存储（默认）：**
```xml
<blobStores>
  <FileBlobStore>
    <id>default</id>
    <enabled>true</enabled>
    <baseDirectory>/opt/gwc_cache</baseDirectory>
  </FileBlobStore>
</blobStores>
```

**S3存储：**
```xml
<S3BlobStore>
  <id>s3store</id>
  <bucket>geoserver-tiles</bucket>
  <prefix>cache</prefix>
  <awsAccessKey>ACCESS_KEY</awsAccessKey>
  <awsSecretKey>SECRET_KEY</awsSecretKey>
</S3BlobStore>
```

### 8.2.6 缓存策略

**基于时间的过期：**
```xml
<expireCache>3600</expireCache>
<expireClients>600</expireClients>
```

**基于变更的过期：**

配置GeoServer在数据变更时自动截断相关缓存。

## 8.3 JVM调优

### 8.3.1 堆内存配置

**设置堆内存大小：**
```bash
export JAVA_OPTS="$JAVA_OPTS -Xms2g -Xmx4g"
```

**内存配置建议：**
| 系统内存 | 推荐最大堆 | 说明 |
|---------|-----------|------|
| 4GB | 1.5GB | 小型开发环境 |
| 8GB | 4GB | 中型生产环境 |
| 16GB | 8-10GB | 大型生产环境 |
| 32GB+ | 16GB | 高负载环境 |

不建议将堆内存设置为系统内存的50%以上，需要为操作系统和文件缓存留出空间。

### 8.3.2 垃圾收集器选择

**G1GC（推荐用于大内存）：**
```bash
export JAVA_OPTS="$JAVA_OPTS \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:G1HeapRegionSize=16m"
```

**ZGC（Java 11+，超低延迟）：**
```bash
export JAVA_OPTS="$JAVA_OPTS \
  -XX:+UseZGC \
  -XX:+ZGenerational"
```

**Shenandoah（Java 11+，低延迟）：**
```bash
export JAVA_OPTS="$JAVA_OPTS \
  -XX:+UseShenandoahGC"
```

### 8.3.3 GC日志配置

**启用GC日志：**
```bash
# Java 8
export JAVA_OPTS="$JAVA_OPTS \
  -XX:+PrintGCDetails \
  -XX:+PrintGCDateStamps \
  -Xloggc:/var/log/geoserver/gc.log"

# Java 11+
export JAVA_OPTS="$JAVA_OPTS \
  -Xlog:gc*:file=/var/log/geoserver/gc.log:time,uptime,level,tags"
```

### 8.3.4 元空间配置

```bash
export JAVA_OPTS="$JAVA_OPTS \
  -XX:MetaspaceSize=256m \
  -XX:MaxMetaspaceSize=512m"
```

### 8.3.5 GeoServer特定JVM参数

```bash
export JAVA_OPTS="$JAVA_OPTS \
  -Dfile.encoding=UTF-8 \
  -Djava.awt.headless=true \
  -Dorg.geotools.referencing.forceXY=true \
  -DGEOSERVER_DATA_DIR=/opt/geoserver_data \
  -DGEOWEBCACHE_CACHE_DIR=/opt/gwc_cache"
```

## 8.4 数据库连接池优化

### 8.4.1 连接池参数

PostGIS数据存储的连接池配置：

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| min connections | 1-5 | 最小空闲连接 |
| max connections | 20-50 | 最大连接数 |
| Connection timeout | 20 | 获取连接超时（秒） |
| validate connections | true | 验证连接有效性 |
| fetch size | 1000 | 批量获取大小 |
| Expose primary keys | true | 暴露主键 |
| Prepared statements | true | 使用预编译语句 |
| Loose bbox | true | 宽松边界框（提升性能） |
| Estimated extends | true | 使用估算范围 |

### 8.4.2 PostgreSQL服务器调优

**postgresql.conf关键参数：**
```
# 内存设置
shared_buffers = 4GB           # 25%系统内存
effective_cache_size = 12GB    # 75%系统内存
work_mem = 256MB               # 每个操作的内存
maintenance_work_mem = 1GB     # 维护操作内存

# 写入设置
wal_buffers = 64MB
checkpoint_completion_target = 0.9

# 连接设置
max_connections = 200

# 查询优化
random_page_cost = 1.1         # SSD存储
effective_io_concurrency = 200 # SSD存储
```

### 8.4.3 PostGIS优化

**空间索引：**
```sql
-- 创建GIST索引
CREATE INDEX idx_roads_geom ON roads USING GIST (geom);

-- 创建聚簇索引（提高空间查询性能）
CLUSTER roads USING idx_roads_geom;

-- 更新统计信息
ANALYZE roads;
```

**简化复杂几何：**
```sql
-- 对于Web显示，可以简化几何
ALTER TABLE roads ADD COLUMN geom_simplified geometry;
UPDATE roads SET geom_simplified = ST_Simplify(geom, 0.0001);
CREATE INDEX idx_roads_geom_simp ON roads USING GIST (geom_simplified);
```

## 8.5 图像处理优化

### 8.5.1 JAI（Java Advanced Imaging）配置

在GeoServer管理界面配置JAI参数：

1. 进入"设置" > "全局"
2. 找到"JAI"部分
3. 配置参数：

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| Memory Capacity | 0.5 | JAI使用的堆内存比例 |
| Memory Threshold | 0.75 | 触发瓦片回收的阈值 |
| Tile Threads | CPU核心数 | 并行处理线程数 |
| Tile Priority | 5 | 瓦片处理优先级 |
| JPEG Native Acceleration | true | 启用JPEG原生加速 |
| PNG Native Acceleration | true | 启用PNG原生加速 |
| Mosaic Native Acceleration | true | 启用镶嵌原生加速 |

### 8.5.2 ImageIO扩展

安装ImageIO扩展以获得更好的图像处理性能：

1. 下载ImageIO-Ext扩展
2. 安装GDAL库
3. 配置环境变量

```bash
export GDAL_DATA=/usr/share/gdal
export LD_LIBRARY_PATH=/usr/lib:$LD_LIBRARY_PATH
```

### 8.5.3 栅格数据优化

**使用Cloud Optimized GeoTIFF（COG）：**
```bash
gdal_translate -of COG \
  -co COMPRESS=LZW \
  -co BLOCKSIZE=512 \
  input.tif output_cog.tif
```

**添加金字塔：**
```bash
gdaladdo -r average output_cog.tif 2 4 8 16 32
```

### 8.5.4 输出格式优化

**配置JPEG质量：**
```xml
<format>
  <id>image/jpeg</id>
  <quality>0.75</quality>
</format>
```

**使用WebP格式（如果客户端支持）：**
- 更小的文件体积
- 支持透明度
- 更好的压缩效果

## 8.6 集群部署方案

### 8.6.1 集群架构

GeoServer集群部署的典型架构：

```
                    ┌──────────────────┐
                    │   Load Balancer  │
                    │   (Nginx/HAProxy) │
                    └────────┬─────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   GeoServer 1   │ │   GeoServer 2   │ │   GeoServer 3   │
│   (Node 1)      │ │   (Node 2)      │ │   (Node 3)      │
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                   │
         └───────────────────┼───────────────────┘
                             │
                    ┌────────┴────────┐
                    │  Shared Storage │
                    │  (NFS/GlusterFS)│
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    │    Database     │
                    │   (PostGIS)     │
                    └─────────────────┘
```

### 8.6.2 配置共享存储

**使用NFS：**
```bash
# 在NFS服务器上
mkdir /export/geoserver_data
echo "/export/geoserver_data *(rw,sync,no_subtree_check)" >> /etc/exports
exportfs -a

# 在GeoServer节点上
mount -t nfs nfs-server:/export/geoserver_data /opt/geoserver_data
```

### 8.6.3 负载均衡配置

**Nginx配置：**
```nginx
upstream geoserver_cluster {
    least_conn;
    server geoserver1:8080 weight=1;
    server geoserver2:8080 weight=1;
    server geoserver3:8080 weight=1;
}

server {
    listen 80;
    server_name geoserver.example.com;

    location /geoserver {
        proxy_pass http://geoserver_cluster;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 健康检查
        proxy_connect_timeout 5s;
        proxy_read_timeout 300s;
    }
}
```

### 8.6.4 集群同步

**JDBCConfig扩展：**

使用JDBCConfig将配置存储到数据库，实现配置共享：

1. 安装JDBCConfig扩展
2. 配置数据库连接
3. 所有节点使用同一配置数据库

**配置同步机制：**

当一个节点修改配置后，通知其他节点重新加载：

```bash
# 在每个节点执行
curl -u admin:geoserver -X POST \
  http://localhost:8080/geoserver/rest/reload
```

### 8.6.5 瓦片缓存共享

使用共享的瓦片缓存目录或分布式存储：

```xml
<blobStores>
  <FileBlobStore>
    <baseDirectory>/shared/gwc_cache</baseDirectory>
  </FileBlobStore>
</blobStores>
```

或使用S3等云存储：

```xml
<S3BlobStore>
  <bucket>geoserver-tiles</bucket>
  <region>us-east-1</region>
</S3BlobStore>
```

## 8.7 故障排查与维护

### 8.7.1 常见问题排查

**内存不足：**
```
错误: java.lang.OutOfMemoryError: Java heap space
解决: 
1. 增加-Xmx参数
2. 检查是否有内存泄漏
3. 分析GC日志
```

**数据库连接问题：**
```
错误: Could not obtain connection from pool
解决:
1. 检查数据库是否可达
2. 增加连接池大小
3. 检查数据库最大连接数
4. 检查validate connections设置
```

**文件权限问题：**
```
错误: Permission denied
解决:
1. 检查数据目录权限
2. 检查日志目录权限
3. 确保运行用户有正确权限
```

### 8.7.2 日志分析

**重要日志位置：**
- GeoServer日志：`data_dir/logs/geoserver.log`
- Tomcat日志：`tomcat/logs/catalina.out`
- 系统日志：`/var/log/syslog`或`/var/log/messages`

**日志级别调整：**
```bash
# 临时开启详细日志
curl -u admin:geoserver -X PUT \
  -H "Content-Type: application/json" \
  -d '{"logging":{"level":"VERBOSE_LOGGING"}}' \
  http://localhost:8080/geoserver/rest/logging
```

### 8.7.3 性能诊断工具

**使用JVisualVM：**
```bash
jvisualvm
```

功能：
- 监控CPU和内存使用
- 分析线程状态
- 创建堆转储
- 采样CPU性能

**使用jstack分析线程：**
```bash
# 获取线程转储
jstack <pid> > thread_dump.txt

# 分析阻塞线程
grep -A 20 "BLOCKED" thread_dump.txt
```

**使用jmap分析内存：**
```bash
# 生成堆转储
jmap -dump:format=b,file=heap.hprof <pid>

# 查看堆统计
jmap -histo <pid> | head -20
```

### 8.7.4 维护任务

**定期维护清单：**

| 任务 | 频率 | 说明 |
|------|------|------|
| 备份配置 | 每日 | 备份数据目录 |
| 清理日志 | 每周 | 删除过期日志 |
| 检查磁盘空间 | 每日 | 监控磁盘使用 |
| 更新统计信息 | 每周 | 数据库ANALYZE |
| 清理临时文件 | 每周 | 清理temp目录 |
| 重启服务 | 每月 | 释放内存碎片 |
| 安全更新 | 及时 | 应用安全补丁 |

**维护脚本示例：**
```bash
#!/bin/bash

# GeoServer维护脚本
LOG_DIR="/opt/geoserver_data/logs"
TEMP_DIR="/opt/geoserver_data/temp"
BACKUP_DIR="/backup/geoserver"

# 清理旧日志（保留30天）
find $LOG_DIR -name "*.log" -mtime +30 -delete

# 清理临时文件
find $TEMP_DIR -mtime +7 -delete

# 检查磁盘空间
DISK_USAGE=$(df /opt/geoserver_data | tail -1 | awk '{print $5}' | tr -d '%')
if [ $DISK_USAGE -gt 80 ]; then
    echo "警告: 磁盘使用率超过80%"
    # 发送告警邮件或通知
fi

# 备份配置
DATE=$(date +%Y%m%d)
tar -czf $BACKUP_DIR/geoserver_$DATE.tar.gz -C /opt geoserver_data

echo "维护任务完成: $(date)"
```

### 8.7.5 灾难恢复

**恢复步骤：**

1. 停止GeoServer服务
2. 恢复数据目录备份
3. 验证配置文件完整性
4. 重启GeoServer
5. 验证服务正常

```bash
#!/bin/bash

# 灾难恢复脚本
BACKUP_FILE=$1
DATA_DIR="/opt/geoserver_data"

# 停止服务
systemctl stop geoserver

# 备份当前配置（以防万一）
mv $DATA_DIR ${DATA_DIR}.old.$(date +%Y%m%d%H%M)

# 恢复备份
tar -xzf $BACKUP_FILE -C /opt

# 修复权限
chown -R geoserver:geoserver $DATA_DIR

# 启动服务
systemctl start geoserver

# 验证服务
sleep 30
curl -s http://localhost:8080/geoserver/rest/about/version.json && \
  echo "恢复成功" || echo "恢复可能失败，请检查日志"
```

## 本章小结

本章详细介绍了GeoServer的性能优化和高级配置：

1. **性能监控**：学会使用各种工具监控GeoServer性能
2. **瓦片缓存**：掌握GeoWebCache的配置和优化
3. **JVM调优**：理解内存配置和垃圾收集器选择
4. **数据库优化**：学会优化数据库连接池和PostGIS
5. **图像处理**：了解JAI配置和栅格数据优化
6. **集群部署**：掌握高可用架构的设计和配置
7. **故障排查**：学会诊断和解决常见问题

性能优化是一个持续的过程，需要根据实际负载和业务需求不断调整。建立完善的监控和维护机制是确保GeoServer稳定运行的关键。

## 思考与练习

1. 为GeoServer配置JMX监控，使用JConsole观察性能指标。
2. 配置图层的瓦片缓存，并使用种子工具预生成瓦片。
3. 根据服务器配置，设计合适的JVM参数。
4. 优化PostGIS数据源的连接池配置。
5. 编写性能监控脚本，定期检查GeoServer状态。
6. 设计一个两节点的GeoServer集群方案。
7. 制定GeoServer维护计划，包括备份、清理和更新策略。
